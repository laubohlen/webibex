{% extends 'layouts/empty.html' %} {% block content %}
<form
    method="POST"
    action="{% url 'saved-animal-selection' %}"
>
    {% csrf_token %}
    <div x-data="{ selectedAnimalId: null }">
        <div class="flex items-center [&>div>p]:mb-0 justify-center grid-cols-[{{ gallery_chips|length }}] gap-[{{ gallery_chips|length }}]">
            <!-- show query image on the left side -->
            <div class="mx-6">
                <h3 class="">Query</h3>
                <img src="{{ query_chip.url }}" />
                <p>Rank:</p>
                <p>Distance:</p>
            </div>
            <!-- show closest matches one by one next to the query -->
            {% for chip, distance in gallery_and_distances %}
            <div
                @click="selectedAnimalId = (selectedAnimalId === {{ chip.ibex_image.animal.id }} ? null : {{ chip.ibex_image.animal.id }})"
                :class="{ 'border-blue-600 ring-2 ring-blue-600 bg-blue-100': selectedAnimalId === {{ chip.ibex_image.animal.id }}, 
                'hover:bg-blue-100': selectedAnimalId !== {{ chip.ibex_image.animal.id }}}"
                class="border-2 border-transparent cursor-pointer"
            >
                <h3>{{ chip.ibex_image.animal.id_code }} ({{ chip.ibex_image.side }})</h3>
                <img
                    src="{{ chip.url }}"
                    class=""
                />
                <p>{{ forloop.counter }}.</p>
                {% if distance <= threshold %}
                <p class="text-green-400">{{ distance }}</p>
                {% else %}
                <p class="text-red-500">{{ distance }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Dropdown menu for selecting an image -->
        <div class="flex flex-row items-center justify-center mt-6">
            <label
                for="imageDropdown"
                class="mr-4"
                >Or choose an existing ID:</label
            >
            <select
                id="imageDropdown"
                x-model="selectedAnimalId"
                class="border border-gray-300 rounded-lg p-2"
            >
                <option value="">---</option>
                <!-- Default empty option -->
                {% for animal in known_animals %}
                <option value="{{ animal.id }}">{{ animal.id_code }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Hidden input to carry selected animal -->
        <input
            type="hidden"
            name="selectedAnimalId"
            :value="selectedAnimalId"
        />
        <!-- Hidden input to carry query chip id variable -->
        <input
            type="hidden"
            name="query_chip_id"
            value="{{ query_chip.id }}"
        />
        <div class="flex flex-row items-center justify-center gap-8 mt-10 mb-10">
            <!-- create a new ibex, autogenerates a new ID code -->
            <a
                href="{% url 'new-ibex' oid=query_chip.id %}"
                class="button"
                >New ID</a
            >
            <!-- confirm the selected chip/identity -->
            <button
                type="submit"
                :disabled="!selectedAnimalId"
                :class="{ '!opacity-50 !cursor-not-allowed': !selectedAnimalId, 'bg-blue-500 hover:bg-blue-600': selectedAnimalId }"
                class="button"
            >
                Select ID
            </button>
        </div>
    </div>
</form>
{% endblock %}
