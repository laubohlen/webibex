{% extends 'layouts/empty.html' %} {% block content %} {% load custom_template_tags %}
<form
    method="POST"
    action="{% url 'saved-animal-selection' %}"
>
    {% csrf_token %}
    <div x-data="{ selectedAnimalId: null }">
        <div class="max-w-screen-lg mx-auto text-center">
            <div class="inline-block text-left">
                <p>Select the matching horn:</p>
                <div class="mt-4 flex items-center justify-center grid-cols-[{{ gallery_chips|length }}] gap-[{{ gallery_chips|length }}]">
                    <!-- show query image on the left side -->
                    <div class="mr-6">
                        {% if query_chip.ibex_image.animal %}
                        <p class="inline-block px-1 py-1 rounded bgBlueCustom text-white">{{ query_chip.ibex_image.animal.id_code }} ({{ query_chip.ibex_image.side }})</p>
                        {% else %}
                        <p class="inline-block px-1 py-1 rounded bgBlueCustom text-white">Query ({{ query_chip.ibex_image.side }})</p>
                        {% endif %}
                        <img
                            class="mt-1"
                            src="{{ query_chip.url }}"
                            alt="Query Chip"
                        />
                        <!-- <p>Rank:</p> -->
                        <p class="mt-1 inline-block py-1">Match:</p>
                    </div>
                    <!-- show closest matches one by one next to the query -->
                    {% for chip, distance in gallery_and_distances %}
                    <div
                        @click="selectedAnimalId = (selectedAnimalId === {{ chip.ibex_image.animal.id }} ? null : {{ chip.ibex_image.animal.id }})"
                        :class="{ 'border-blue-600 ring-2 ring-blue-600 bg-blue-100': selectedAnimalId === {{ chip.ibex_image.animal.id }}, 
                            'hover:bg-blue-100': selectedAnimalId !== {{ chip.ibex_image.animal.id }} }"
                        class="border-2 border-transparent cursor-pointer"
                    >
                        <p class="{{ id_to_color|dict_get:chip.ibex_image.animal.id }} text-white inline-block px-1 py-1 rounded">{{ chip.ibex_image.animal.id_code }} ({{ chip.ibex_image.side }})</p>
                        <img
                            class="mt-1"
                            src="{{ chip.url }}"
                            alt="Gallery Chip"
                        />
                        <!-- <p>{{ forloop.counter }}.</p> -->
                        {% if distance <= threshold %}
                        <p class="bg-green-500 text-white inline-block px-1 py-1 rounded mt-1">{{ distance }}</p>
                        {% else %}
                        <p class="bg-red-400 text-white inline-block px-1 py-1 rounded mt-1">{{ distance }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Dropdown menu for selecting an image -->
        <div class="flex flex-row items-center justify-center mt-4">
            <label
                for="imageDropdown"
                class="mr-4"
                >Or choose an existing ID:</label
            >
            <select
                id="imageDropdown"
                x-model="selectedAnimalId"
                class="border border-gray-300 rounded-lg p-2"
            >
                <option value="">---</option>
                <!-- Default empty option -->
                {% for animal in known_animals %}
                <option value="{{ animal.id }}">{{ animal.id_code }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Hidden input to carry selected animal -->
        <input
            type="hidden"
            name="selectedAnimalId"
            :value="selectedAnimalId"
        />
        <!-- Hidden input to carry query chip id variable -->
        <input
            type="hidden"
            name="query_chip_id"
            value="{{ query_chip.id }}"
        />
        <div class="flex flex-row items-center justify-center gap-8 mt-4">
            <!-- create a new ibex, autogenerates a new ID code -->
            <a
                href="{% url 'new-ibex' oid=query_chip.id %}"
                class="button"
                >New ID</a
            >
            <!-- confirm the selected chip/identity -->
            <button
                type="submit"
                :disabled="!selectedAnimalId"
                :class="{ '!opacity-50 !cursor-not-allowed': !selectedAnimalId, 'bg-blue-500 hover:bg-blue-600': selectedAnimalId }"
                class="button"
            >
                Select ID
            </button>
        </div>
    </div>
</form>
{% endblock %}
